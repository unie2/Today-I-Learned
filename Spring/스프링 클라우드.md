## 스프링 클라우드(Spring Cloud)를 활용한 클라우드 네이티브 애플리케이션 개발

### 1. 클라우드 네이티브 애플리케이션
클라우드 네이티브를 이해하기 위해서는 먼저 클라우드 환경에서 실행하는 SaaS 애플리케이션의 특징을 알아야 한다.

- SaaS(Software as a Service) 애플리케이션의 특징   
  ````
  1. 설정 자동화 절차를 체계화하여(Declarative) 새로운 개발자가 프로젝트에 참여하는 데 드는 시간과 비용을 최소화한다.
  2. 운영체제에 따라 달라지는 부분을 명확히 하고 실행 환경 사이의 이식성을 극대화한다.
  3. 최근 등장한 클라우드 플랫폼에 적합하고 서버와 시스템의 관리가 필요 없다.
  4. 개발 환경과 운영 환경의 차이를 최소화하고 민첩성을 극대화하면서 지속적인 배포가 가능하다.
  5. 툴, 아키텍처 및 개발 방식을 크게 바꾸지 않고 확장할 수 있다.
  ````

이와 같은 애플리케이션을 만들기 위해 Heroku의 엔지니어들이 Twelve-Factor App 이라는 SaaS 앱 개발 방법론을 정의
````
1. [코드베이스] : 버전 관리되는 하나의 코드베이스와 다양한 배포
  - 애플리케이션당 하나의 코드베이스만 존재하고 이를 CI/CD를 통해서 다양한 환경(개발, 테스트, 운영)에 배포

2. [종속성] : 명시적으로 선언되고 분리된 종속성
  - Maven과 같은 종속성 관리 도구를 사용
  
3. [설정] : 환경(environment)에 저장된 설정
  - 설정과 코드를 명시적으로 분리하여 실행 환경에 맞는 설정으로 유연하게 변경이 가능하게 한다.
  
4. [백엔드 서비스] : 백엔드 서비스를 연결된 리소스로 취급
  - 네트워크를 통해서 사용하는 외부의 서비스를 리소스로 간주
  - 설정 시스템에 저장된 값을 읽어 해당 리소스에 접근
  
5. [빌드, 릴리즈, 실행] : 철저하게 분리한 빌드와 실행 단계
  - CI/CD를 통해서 빌드와 릴리즈 단계를 분리

6. [프로세스] : 애플리케이션을 하나 또는 여러 개의 무상태(stateless) 프로세스로 실행
  - 클라우드에서 연산은 상태(State)가 없어야 한다.
  
7. [포트 바인딩] : 포트 바인딩을 사용해서 서비스 공개
  - 앱은 독립적이어야 한다.
  - 실행 환경에 대한 런타임 인젝션에 의존하지 않는다.
  - 각 서비스는 HTTP 환경으로 제공되며 API를 통해서만 접근한다.
  - 데이터는 공유하지 않는다.

8. [동시성] : 프로세스 모델을 사용한 확장
  - 확장과 자원 사용량 개선을 위해서 각 서비스와 함수는 독립적이고 수평적으로 동작
  
9. [폐기 가능] : 빠른 시작과 그레이스 풀 셧다운(Graceful shutdown)을 통한 안정성 극대화
  - 개별 프로세스들은 쉽게 종료할 수 있고 빠르게 시작할 수 있다.
  
10. [개발/프로덕션환경 일치] : 개발, 스테이징, 프로덕션 환경을 최대한 비슷하게 유지
  - 각각의 환경 차이를 줄임으로써 지속적인 배포가 가능하도록 지원
  
11. [로그] : 로그를 이벤트 스트림으로 취급
  - 분산 시스템에서 로그를 관리하는 것은 중요하다.
  - 개별 앱은 이를 관리하지 않고 외부 시스템으로 전달하기만 한다.

12. [Admin 프로세스] : admin/maintenance 작업을 일회성 프로세스로 실행
  - 관리를 위한 코드와 작업을 분리하지 않고 동일한 환경에서 배포, 실행한다.

````

- - -
### 2. 스프링 클라우드
- 스프링 클라우드 지원
  - 분산, 버전 설정 (Spring Cloud Config)
    - 대부분의 경우 설정 파일은 바이너리와 함께 배포되며 환경 혹은 실행 옵션으로 실제 값이 선택된다.
    - 그러나 클라우드 환경에서 마이크로서비스를 지원하는 경우 환경 자체의 값들이 자유롭게 변경, 처리될 수 있어야 한다.
    - 즉, 중앙저장소에서 모든 설정 값을 관리하고 개별 서비스는 설정 값을 해당 저장소에 문의하여 가져와야 한다.
    - 스프링 클라우드 Config는 `외부화된 구성(Config)`에 대해 서버 및 클라이언트 측 지원을 제공한다.
    - 기본적으로 설정은 키-값 (Key-Value)의 쌍으로 되어 있고 필요 시 암호화할 수 있다.

  - 서비스 등록 및 조회
    - 스프링 클라우드는 `Spring Cloud Netflix(Eureka)`, `Spring Cloud Consul(Hashicorp's Consul)`, `Spring Cloud Zookeeper(Apache Zookeeper)`의 프로젝트에서 개별 솔루션과의 연동을 지원한다.
    - 이런 솔루션이 단순히 키-값의 정보만을 제공하는 건 아니며, 복제, 고가용성 등의 다른 기능도 가지고 있다.
    - 각자의 운영 환경에 적합한 프로젝트를 선택하여 활용하면 된다.

  - 라우팅
    "라우팅 : 특정 네트워크 내부에서 목적지를 찾아가는 과정" -> 이때 사용하는 것이 API 게이트웨이
    - API 게이트웨이는 외부에 노출하는 포인트를 하나로 만들어 관리가 편해지고 인증 혹은 SSL 처리를 담당하여 게이트웨이 내부의 모듈을 더 간단하게 만들 수 있도록 도와준다.
    - 스프링 클라우드는 Spring Cloud Netflix(Zuul)를 지원하고 내부 프로젝트인 Spring Cloud Gateway 또한 제공하고 있다.
  
  - 서비스 간 호출
    - 마이크로서비스 환경에서 서비스 간 호출은 매우 빈번하게 발생한다.
    - API 게이트웨이를 활용해 작업을 수행할 수 있지만 신뢰할 수 있는 내부망에서 SSL, 필터링 처리 등 불필요한 부하가 발생한다.
    - 또한, 이러한 호출은 일대일 호출과 일대다 호출로 구분할 수 있다.
      ````
      1. 일대일 호출 : 직접 서비스 주소를 찾아서 호출하거나 클라이언트사이드 부하분산 솔루션인 리본(Ribbon)을 활용하는 것이 일반적
      2. 일대다 호출 : 분산 메시징 활용 가능
      ````
    - 스프링 클라우드는 Spring Cloud Netflix(Ribbon)를 지원한다.

  - 부하 분산
    - 클라우드 환경에서는 동일한 서비스를 처리하는 인스턴스가 많을 수 있다.
    - 이 중에서 인스턴스로 호출하는 것, 그리고 부하를 분산시키는 것이 중요하다.
    - API 게이트 웨이나 클라이언트사이드 부하 분산 솔루션은 다양한 알고리즘으로 이를 지원한다.
      ````
      리본 - 라운드 로빈(Round Robin) 이외에 평균 응답시간을 기록해서 활용하는 방법, 현재 연결된 서비스 수를 받아서 활용하는 방법 등
      ````
    - 리본 외에도 스프링은 클라이언트의 부하 분산을 위한 모듈을 제공한다.
      ````
      스프링 클라우드 로드밸런서(Spring Cloud Loadbalancer) - 리본에서 발생했던 단점과 사용성이 개선
      ````
      
  - 서킷 브레이커 (Circuit Breakers)
    - 동일한 서비스를 제공하는 여러 인스턴스 중 하나에서 장애가 발생할 경우 해당 인스턴스에 계속 요청을 보내 타임아웃(Timeout)까지 기다리는 것은 전체 시스템에 부하를 준다.
    - `서킷 브레이커`가 장애가 발생한 인스턴스로 가는 요청을 중단 시켜주는 역할을 한다.
    - 리본이나 주울(Zuul) 모두 이러한 기능을 갖추고 있다.

  - Global Locks, Leadership Election and Cluster State
    - 클라우드 네이티브 환경에서 특정 리소스에 하나의 모듈만 접근해야 하는 경우가 종종 발생하는데, 이때 필요한 것이 `Global Lock` 이다.
      ````
      Global Lock : 해당 리소스에 접근한 모듈이 잠금(Lock)을 생성하고, 이후 접근한 모듈이 잠금 상태라면 대기, 잠금이 없다면 자신이 잠금을 잡는 방식
                -> 각각의 인스턴스가 개별로 동작하므로 이런 잠금은 하나의 시스템이 아닌 전체를 대상으로 관리되어야 한다.
      ````
    - 특정 서비스 사이에서 리더(Leader)를 선출하고 관리하는 것도 일반적인 요구조건이다.
    - 전체 시스템에서 하나의 키를 이용해 잠금을 관리할 수 있고 리더 역시 특정 키를 조회해 값이 없으면 조회한 모듈이 자신으로 값을 설정하고, 값이 있으면 해당 모듈을 리더로 판단하면 된다.
    - 리더 대체나 잠금 자동 해제 등 실제 서비스는 키-값 관리 기능 외에 추가 기능을 지원한다.
    - 콘술(Consul)이나 주키퍼(Zookeeper) 모두 이런 기능을 제공한다.

  - 분산 메시징
    - 메시지 큐(Message Queue)를 이용하거나 게시, 구독 모델을 사용해 분산 메시징을 지원할 수 있다.
      ````
      ex. 배달: 고객이 주문 -> 고객, 배달자, 서비스 메인 모듈에 결과(문자) 전달
      ````
    - 세부적으로 들어가면 컨슈머 그룹(Consumer Group)을 활용해 중복 처리를 방지하거나 파티셔닝(Partitioning) 기능을 활용할 수 있다.
    - Spring Cloud Stream은 래빗MQ, 아파치 카프카(Apache Kafka), 구글 펍섭(Google PubSub) 등의 제품과 연계하여 분산 메시징을 지원한다.


- - -
[출처](https://www.samsungsds.com/kr/insights/spring_cloud.html)
